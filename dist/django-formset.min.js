/*! Django Formset - v0.1.0 - 2014-03-03
* https://github.com/mbertheau/jquery.django-formset
* Copyright (c) 2014 Markus Bertheau; Licensed MIT */
var FormsetError,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};FormsetError=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b}(Error),function(a){a.fn.djangoFormset=function(b){return new a.fn.djangoFormset.Formset(this,b)},a.fn.djangoFormset.Formset=function(){function b(b,c){var d,e,f,g;if(this.opts=a.extend({},a.fn.djangoFormset.defaultOptions,c),0===b.length)throw new FormsetError("Empty selector.");if(this.template=b.filter("."+this.opts.formTemplateClass),0===this.template.length)throw new FormsetError("Can't find template (looking for ."+this.opts.formTemplateClass+")");if(f=this.template.find("input,select,textarea").first().attr("name"),!f)throw new FormsetError("Can't figure out form prefix because there's no form element in the form template. Please add one.");if(g=f.indexOf("-__prefix__"),-1===g)throw new FormsetError("Can't figure out form prefix from template because it doesn't contain '-__prefix__'.");if(this.prefix=f.substring(0,g),this.totalForms=a("#id_"+this.prefix+"-TOTAL_FORMS"),0===this.totalForms.length)throw new FormsetError("Management form field 'TOTAL_FORMS' not found for prefix "+this.prefix+".");this._initTabs(),e=b.not("."+this.opts.formTemplateClass),this.initialForms=e.length,this.forms=e.map(function(b){return function(c,d){var e,f;return b.hasTabs&&(f=a.djangoFormset.getTabActivator(d.id),e=new a.fn.djangoFormset.Tab(f.closest(".nav > *"))),new a.fn.djangoFormset.Form(a(d),b,c,e)}}(this)),this.forms.length!==parseInt(this.totalForms.val())&&console.error("TOTAL_FORMS is "+this.totalForms.val()+", but "+this.forms.length+" non-template elements found in passed selection."),d=this.forms.filter(function(){return this.deleteInput.val()}),d.each(function(){return this["delete"]()}),this.insertAnchor=b.not("."+this.opts.formTemplateClass).last(),0===this.insertAnchor.length&&(this.insertAnchor=this.template)}return b.prototype._initTabs=function(){var b;this.hasTabs=this.template.is(".tab-pane"),this.hasTabs&&(b=a.djangoFormset.getTabActivator(this.template.attr("id")).closest(".nav"),this.tabTemplate=b.children("."+this.opts.formTemplateClass))},b.prototype.addForm=function(){var b,c,d,e,f;return this.hasTabs&&(f=this.tabTemplate.clone().removeClass(this.opts.formTemplateClass),e=new a.fn.djangoFormset.Tab(f),b=this.forms[this.forms.length-1],f.insertAfter(b.tab.elem)),d=this.template.clone().removeClass(this.opts.formTemplateClass),c=new a.fn.djangoFormset.Form(d,this,parseInt(this.totalForms.val()),e),d.insertAfter(this.insertAnchor),this.insertAnchor=d,this.forms.push(c),this.totalForms.val(parseInt(this.totalForms.val())+1),this.hasTabs&&e.activate(),a(this).trigger("formAdded",[c]),c},b.prototype.deleteForm=function(a){var b;b=this.forms[a],b["delete"]()},b.prototype.handleFormRemoved=function(a){var b,c,d,e,f;for(this.totalForms.val(parseInt(this.totalForms.val())-1),this.forms.splice(a,1),f=this.forms,c=d=0,e=f.length;e>d;c=++d)b=f[c],b._updateFormIndex(c);this.insertAnchor=0===this.forms.length?this.template:this.forms[this.forms.length-1].elem},b}(),a.fn.djangoFormset.Form=function(){function b(a,b,c,d){var e,f;this.elem=a,this.formset=b,this.index=c,this.tab=d,void 0!==this.index&&this._initFormIndex(this.index),e=""+this.formset.prefix+"-"+this.index+"-DELETE",this.deleteInput=this.elem.find("input[name='"+e+"']"),f=this.index<this.formset.initialForms,(this.deleteInput.length>0||!f)&&(this._hideDeleteCheckbox(),this._addDeleteButton())}return b.prototype.getDeleteButton=function(){return a('<button type="button" class="btn btn-danger"> Delete </button>')},b.prototype.getDeleteButtonContainer=function(){return this.elem.is("TR")?this.elem.children().last():this.elem.is("UL")||this.elem.is("OL")?this.elem.append("li").children().last():this.elem},b.prototype["delete"]=function(){var a,b,c;return 0===this.deleteInput.length?void console.warn("Tried do delete non-deletable form "+this.formset.prefix+" #"+this.index+"."):(a=this.index<this.formset.initialForms,this.tab&&(c=this.formset.forms.map(function(a,b){return b.tab.elem[0]}),b=c.slice(this.index+1).filter(":visible").first(),0===b.length&&(b=c.slice(0,this.index).filter(":visible").last()),b.length>0&&b.data("djangoFormset.tab").activate()),void(a?(this.deleteInput.val("on"),this.tab&&this.tab.elem.hide(),this.hide()):(this.tab&&this.tab.elem.remove(),this.elem.remove(),this.formset.handleFormRemoved(this.index))))},b.prototype.hide=function(){return this.elem.hide()},b.prototype._hideDeleteCheckbox=function(){var a;return this.elem.append("<input type='hidden' name='"+this.deleteInput.attr("name")+"' id='"+this.deleteInput.attr("id")+"' value='"+(this.deleteInput.is(":checked")?"on":"")+"'/>"),a=this.elem.children().last(),this.elem.find("label[for='"+this.deleteInput.attr("id")+"']").remove(),this.deleteInput.remove(),this.deleteInput=a},b.prototype._addDeleteButton=function(){return this.deleteButton=this.getDeleteButton(),this.getDeleteButtonContainer().append(this.deleteButton),this.deleteButton.on("click",function(a){return function(){return a["delete"]()}}(this))},b.prototype._replaceFormIndex=function(b,c){var d,e,f;this.index=c,e=new RegExp(""+this.formset.prefix+"-"+b),d=""+this.formset.prefix+"-"+c,f=function(a){var b,c,f,g,h,i,j;f={input:["id","name"],select:["id","name"],textarea:["id","name"],label:["for"],div:["id"],"*":["href","data-target"]},g=a.get(0).tagName,c=[],g.toLowerCase()in f&&(c=f[g.toLowerCase()]),c.push.apply(c,f["*"]),j=[];for(h=0,i=c.length;i>h;h++)b=c[h],j.push(a.attr(b)?a.attr(b,a.attr(b).replace(e,d)):void 0);return j},f(this.elem),this.elem.find("input, select, textarea, label").each(function(){f(a(this))}),this.tab&&(f(this.tab.elem),this.tab.elem.find("a, button").each(function(){f(a(this))}))},b.prototype._initFormIndex=function(a){this._replaceFormIndex("__prefix__",a)},b.prototype._updateFormIndex=function(a){this._replaceFormIndex("\\d+",a)},b}(),a.fn.djangoFormset.Tab=function(){function a(a){this.elem=a,this.elem.data("djangoFormset.tab",this)}return a.prototype.activate=function(){return this.elem.find("[data-toggle='tab']").trigger("click")},a.prototype.remove=function(){return this.elem.remove()},a}(),a.fn.djangoFormset.defaultOptions={formTemplateClass:"empty-form"},a.djangoFormset={getTabActivator:function(b){return a("[href='#"+b+"'], [data-target='#"+b+"']")}}}(jQuery);